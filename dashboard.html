<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Ordini - The Server Bistrot</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #1a1d21;
            --bg-light: #2c3138;
            --bg-card: #25292e;
            --primary-text: #f0f0f0;
            --secondary-text: #a0a7b3;
            --accent: #d4a574;
            --accent-dark: #b8935f;
            --border-color: #3d444e;
            --status-new: #38a169;       /* Verde */
            --status-progress: #dd6b20;  /* Arancione */
            --status-urgent: #e53e3e;     /* Rosso */
            --status-ready: #5a6472;      /* Grigio */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--primary-text);
            line-height: 1.6;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        header h1 {
            font-family: 'Playfair Display', serif;
            color: var(--accent);
            font-size: 2.5rem;
        }
        
        #currentTime {
            font-size: 1.2rem;
            color: var(--secondary-text);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .summary-card {
            background-color: var(--bg-light);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .summary-card h2 {
            font-size: 1rem;
            color: var(--secondary-text);
            margin-bottom: 10px;
            font-weight: 500;
        }

        .summary-card .value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-text);
        }
        
        .summary-card#monthly-total .value {
             color: var(--accent);
        }

        .controls {
            margin-bottom: 25px;
            background-color: var(--bg-light);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        
        .controls label {
            font-weight: 600;
            margin-right: 15px;
        }

        .controls select {
            font-family: 'Inter', sans-serif;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-card);
            color: var(--primary-text);
            font-size: 1rem;
        }

        #orders-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .order-card {
            background-color: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .order-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        .order-card-header {
            padding: 15px 20px;
            background-color: var(--bg-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .order-card-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .order-card-header .order-time {
            font-size: 0.9rem;
            color: var(--secondary-text);
        }

        .order-card-body {
            padding: 20px;
            flex-grow: 1;
        }
        
        .order-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .order-info span {
            font-weight: 500;
        }

        .dishes-list {
            list-style: none;
        }

        .dishes-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 1rem;
        }
        
        .dish-name {
            flex-grow: 1;
        }

        .countdown {
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 20px;
            color: white;
            font-size: 0.95rem;
            min-width: 80px;
            text-align: center;
        }

        .countdown.status-new { background-color: var(--status-new); }
        .countdown.status-progress { background-color: var(--status-progress); }
        .countdown.status-urgent { background-color: var(--status-urgent); }
        .countdown.status-ready { background-color: var(--status-ready); }
        
        .order-card-footer {
            padding: 15px 20px;
            background-color: var(--bg-light);
            text-align: right;
            border-top: 1px solid var(--border-color);
        }

        .order-total {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent);
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <header>
            <h1>Dashboard Ordini</h1>
            <div id="currentTime"></div>
        </header>

        <section class="summary-grid">
            <div class="summary-card" id="daily-total">
                <h2>Incasso di Oggi</h2>
                <div id="totalDailyEarnings" class="value">€ 0.00</div>
            </div>
            <div class="summary-card">
                <h2>Ordini Ricevuti (Oggi)</h2>
                <div id="totalDailyOrders" class="value">0</div>
            </div>
            <div class="summary-card">
                <h2>Coperti Serviti (Oggi)</h2>
                <div id="totalDailyCovers" class="value">0</div>
            </div>
             <div class="summary-card" id="monthly-total" style="display: none;">
                <h2>Incasso del Mese</h2>
                <div id="totalMonthlyEarnings" class="value">€ 0.00</div>
            </div>
        </section>

        <section class="controls">
            <label for="monthFilter">Filtra per periodo:</label>
            <select id="monthFilter"></select>
        </section>

        <main id="orders-container"></main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- DATI DI ESEMPIO ---
            const allOrders = [
                {
                    table: 7,
                    people: 2,
                    timestamp: new Date().getTime() - 60000 * 2, // 2 minuti fa
                    total: 51.50,
                    items: [
                        { name: "Spaghetti alla Carbonara", quantity: 2, prep_time_seconds: 720 }, // 12 min
                        { name: "Acqua Naturale", quantity: 1, prep_time_seconds: 60 }, // 1 min
                    ]
                },
                {
                    table: 3,
                    people: 4,
                    timestamp: new Date().getTime() - 60000 * 8, // 8 minuti fa
                    total: 98.00,
                    items: [
                        { name: "Tagliere di Salumi", quantity: 1, prep_time_seconds: 300 }, // 5 min
                        { name: "Pizza Diavola", quantity: 2, prep_time_seconds: 900 }, // 15 min
                        { name: "Pizza Margherita", quantity: 2, prep_time_seconds: 900 }, // 15 min
                        { name: "Vino della Casa", quantity: 1, prep_time_seconds: 120 }, // 2 min
                    ]
                },
                {
                    table: 12,
                    people: 2,
                    timestamp: new Date().getTime() - 60000 * 25, // 25 minuti fa (dovrebbe essere quasi pronto)
                    total: 41.00,
                    items: [
                        { name: "Petto di Pollo agli Agrumi", quantity: 1, prep_time_seconds: 1500 }, // 25 min
                        { name: "Insalatona", quantity: 1, prep_time_seconds: 480 }, // 8 min
                        { name: "Caffè Espresso", quantity: 2, prep_time_seconds: 180 }, // 3 min
                    ]
                },
                // Ordini dei mesi precedenti
                {
                    table: 5, people: 3, total: 75.50,
                    timestamp: new Date(new Date().setMonth(new Date().getMonth() - 1)).getTime(), // Mese scorso
                    items: [{ name: "Lasagna", quantity: 3, prep_time_seconds: 0 }]
                },
                 {
                    table: 2, people: 2, total: 62.00,
                    timestamp: new Date(new Date().setMonth(new Date().getMonth() - 1)).getTime(), // Mese scorso
                    items: [{ name: "Pizza", quantity: 2, prep_time_seconds: 0 }]
                },
                {
                    table: 8, people: 5, total: 130.00,
                    timestamp: new Date(new Date().setMonth(new Date().getMonth() - 2)).getTime(), // Due mesi fa
                    items: [{ name: "Vari piatti", quantity: 1, prep_time_seconds: 0 }]
                }
            ];

            const ordersContainer = document.getElementById('orders-container');
            const monthFilter = document.getElementById('monthFilter');
            const countdownIntervals = []; // Array per tenere traccia degli intervalli

            // --- FUNZIONI DI VISUALIZZAZIONE ---

            function renderOrders(ordersToRender) {
                ordersContainer.innerHTML = '';
                countdownIntervals.forEach(clearInterval); // Pulisce i vecchi countdown
                countdownIntervals.length = 0;

                if (ordersToRender.length === 0) {
                    ordersContainer.innerHTML = '<p>Nessun ordine trovato per questo periodo.</p>';
                    return;
                }

                ordersToRender.sort((a, b) => b.timestamp - a.timestamp); // Ordini più recenti prima

                ordersToRender.forEach((order, index) => {
                    const orderTime = new Date(order.timestamp);
                    const dishesHtml = order.items.map((item, itemIndex) => `
                        <li>
                            <span class="dish-name">${item.quantity}x ${item.name}</span>
                            <div class="countdown" id="countdown-${index}-${itemIndex}" data-timestamp="${order.timestamp}" data-duration="${item.prep_time_seconds}">--:--</div>
                        </li>
                    `).join('');

                    const orderCard = `
                        <div class="order-card">
                            <div class="order-card-header">
                                <h3>Tavolo ${order.table}</h3>
                                <span class="order-time">${orderTime.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })}</span>
                            </div>
                            <div class="order-card-body">
                                <div class="order-info">
                                    <span><strong>Persone:</strong> ${order.people}</span>
                                </div>
                                <ul class="dishes-list">${dishesHtml}</ul>
                            </div>
                            <div class="order-card-footer">
                                <span class="order-total">Totale: € ${order.total.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                    ordersContainer.insertAdjacentHTML('beforeend', orderCard);
                });
                
                initCountdowns();
            }

            function initCountdowns() {
                const countdownElements = document.querySelectorAll('.countdown');
                countdownElements.forEach(el => {
                    const orderTimestamp = parseInt(el.dataset.timestamp, 10);
                    const durationSeconds = parseInt(el.dataset.duration, 10);
                    const endTime = orderTimestamp + durationSeconds * 1000;

                    const interval = setInterval(() => {
                        const now = new Date().getTime();
                        const remainingTime = endTime - now;

                        if (remainingTime <= 0) {
                            el.textContent = 'Pronto!';
                            el.className = 'countdown status-ready';
                            clearInterval(interval);
                            return;
                        }

                        const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
                        el.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                        // Aggiorna colore in base al tempo rimanente
                        const remainingSeconds = remainingTime / 1000;
                        if (remainingSeconds < 300) { // Meno di 5 minuti
                            el.className = 'countdown status-urgent';
                        } else if (remainingSeconds < 600) { // Meno di 10 minuti
                            el.className = 'countdown status-progress';
                        } else {
                            el.className = 'countdown status-new';
                        }

                    }, 1000);
                    countdownIntervals.push(interval);
                });
            }

            function updateSummary(ordersForSummary) {
                const dailyTotalEl = document.getElementById('totalDailyEarnings');
                const dailyOrdersEl = document.getElementById('totalDailyOrders');
                const dailyCoversEl = document.getElementById('totalDailyCovers');
                
                const total = ordersForSummary.reduce((sum, order) => sum + order.total, 0);
                const covers = ordersForSummary.reduce((sum, order) => sum + order.people, 0);

                dailyTotalEl.textContent = `€ ${total.toFixed(2)}`;
                dailyOrdersEl.textContent = ordersForSummary.length;
                dailyCoversEl.textContent = covers;
            }
            
            function updateMonthlySummary(ordersForSummary) {
                const monthlyTotalCard = document.getElementById('monthly-total');
                const monthlyTotalEl = document.getElementById('totalMonthlyEarnings');
                
                const total = ordersForSummary.reduce((sum, order) => sum + order.total, 0);
                monthlyTotalEl.textContent = `€ ${total.toFixed(2)}`;
                monthlyTotalCard.style.display = 'block';
            }


            // --- LOGICA DI FILTRAGGIO E INIZIALIZZAZIONE ---

            function populateMonthFilter() {
                const months = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
                const now = new Date();
                monthFilter.innerHTML = '<option value="today">Oggi</option>';
                for (let i = 0; i < 6; i++) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const month = date.getMonth();
                    const year = date.getFullYear();
                    monthFilter.innerHTML += `<option value="${year}-${month}">${months[month]} ${year}</option>`;
                }
            }

            function filterAndDisplay() {
                const filterValue = monthFilter.value;
                const now = new Date();
                
                // Nasconde di default i riepiloghi
                document.getElementById('daily-total').style.display = 'none';
                document.getElementById('monthly-total').style.display = 'none';


                let filteredOrders = [];
                
                if (filterValue === 'today') {
                    document.getElementById('daily-total').style.display = 'block';
                    filteredOrders = allOrders.filter(order => {
                        const orderDate = new Date(order.timestamp);
                        return orderDate.getDate() === now.getDate() &&
                               orderDate.getMonth() === now.getMonth() &&
                               orderDate.getFullYear() === now.getFullYear();
                    });
                    updateSummary(filteredOrders);
                } else {
                    const [year, month] = filterValue.split('-').map(Number);
                    filteredOrders = allOrders.filter(order => {
                        const orderDate = new Date(order.timestamp);
                        return orderDate.getMonth() === month &&
                               orderDate.getFullYear() === year;
                    });
                    updateMonthlySummary(filteredOrders);
                }

                renderOrders(filteredOrders);
            }
            
            function updateClock() {
                const now = new Date();
                document.getElementById('currentTime').textContent = now.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' }) + ' - ' + now.toLocaleTimeString('it-IT');
            }

            // --- ESECUZIONE ---
            populateMonthFilter();
            filterAndDisplay();
            monthFilter.addEventListener('change', filterAndDisplay);
            updateClock();
            setInterval(updateClock, 1000);

        });
    </script>
</body>
</html>